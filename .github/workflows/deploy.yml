name: Deploy Medical Dashboard Django App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Set up environment variables
          export DB_NAME=medicdashboard
          export DB_USER=postgres
          export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          export SECRET_KEY=${{ secrets.SECRET_KEY }}
          export ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          export ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          export ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          export DEBUG=False
          export ALLOWED_HOSTS=87.107.111.36,localhost,127.0.0.1
          
          # Create app directory
          APP_DIR="/opt/medical-dashboard"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # Stop existing containers
          echo "üõë Stopping existing containers..."
          docker-compose down || true
          
          # Clone or update repository
          if [ -d ".git" ]; then
            echo "üì• Pulling latest changes..."
            git pull origin main
          else
            echo "üì• Cloning repository..."
            git clone https://github.com/iman244/dashboard-django.git .
          fi
          
          # Build and start containers
          echo "üî® Building and starting containers..."
          docker-compose up -d --build
          
          # Wait for database to be ready
          echo "‚è≥ Waiting for database to be ready..."
          sleep 20
          
          # Check database connection
          echo "üîç Checking database connection..."
          docker-compose exec -T web python manage.py check --database default
          
          # Run Django migrations
          echo "üóÑÔ∏è Running Django migrations..."
          docker-compose exec -T web python manage.py migrate
          
          # Create superuser if it doesn't exist (using environment variables)
          echo "üë§ Checking for superuser..."
          docker-compose exec -T web python manage.py shell -c "
          import os
          from django.contrib.auth import get_user_model
          User = get_user_model()
          admin_username = os.getenv('ADMIN_USERNAME', 'admin')
          admin_email = os.getenv('ADMIN_EMAIL', 'admin@example.com')
          admin_password = os.getenv('ADMIN_PASSWORD')
          if admin_password and not User.objects.filter(username=admin_username).exists():
              User.objects.create_superuser(admin_username, admin_email, admin_password)
              print('‚úÖ Superuser created: ' + admin_username)
          else:
              print('‚úÖ Superuser already exists or no password provided')
          "
          
          # Collect static files
          echo "üì¶ Collecting static files..."
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          # Show running containers
          echo "üìä Checking container status..."
          docker-compose ps
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Your app should be available at: http://87.107.111.36:8000"
